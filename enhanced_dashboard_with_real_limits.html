<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Code Optimizer - Rate Limit Tracker ðŸ”¥</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
            min-height: 100vh;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        h1 {
            color: #60a5fa;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .live-indicator {
            background: linear-gradient(45deg, #10b981, #34d399);
            color: white;
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            display: inline-block;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .rate-limit-card {
            background: linear-gradient(135deg, #1e293b, #334155);
            border-radius: 12px;
            padding: 25px;
            border: 2px solid #3b82f6;
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.2);
        }
        
        .rate-limit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .rate-limit-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #60a5fa;
        }
        
        .rate-limit-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .status-safe { background: #166534; color: #4ade80; }
        .status-warning { background: #92400e; color: #fbbf24; }
        .status-danger { background: #991b1b; color: #f87171; }
        
        .progress-container {
            background: #0f172a;
            border-radius: 8px;
            height: 20px;
            margin: 15px 0;
            overflow: hidden;
            position: relative;
        }
        
        .progress-bar {
            height: 100%;
            border-radius: 8px;
            transition: width 0.5s ease;
            position: relative;
        }
        
        .progress-safe { background: linear-gradient(90deg, #10b981, #34d399); }
        .progress-warning { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        .progress-danger { background: linear-gradient(90deg, #ef4444, #f87171); }
        
        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
        }
        
        .usage-stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-item {
            text-align: center;
            padding: 12px;
            background: #0f172a;
            border-radius: 8px;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #10b981;
        }
        
        .stat-label {
            font-size: 12px;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 5px;
        }
        
        .real-data-card {
            background: linear-gradient(135deg, #1e293b, #334155);
            border-radius: 12px;
            padding: 30px;
            margin: 20px 0;
            border: 2px solid #10b981;
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.2);
            grid-column: 1 / -1;
        }
        
        .token-display {
            text-align: center;
            padding: 20px;
        }
        
        .token-count {
            font-size: 3rem;
            font-weight: bold;
            color: #10b981;
            text-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
            margin: 20px 0;
        }
        
        .refresh-btn {
            background: linear-gradient(45deg, #3b82f6, #1d4ed8);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin: 20px auto;
            display: block;
            transition: transform 0.2s;
        }
        
        .refresh-btn:hover {
            transform: scale(1.05);
        }
        
        .plan-info {
            background: #0f172a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #60a5fa;
        }
        
        .time-remaining {
            font-size: 1.1rem;
            font-weight: bold;
            color: #34d399;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Claude Code Rate Limit Tracker</h1>
        <div class="live-indicator">ðŸ”¥ REAL-TIME MONITORING</div>
    </div>

    <div class="plan-info">
        <strong>Plan:</strong> Max 5x Pro ($100/month) â€¢ 
        <strong>Model Access:</strong> Sonnet + Opus â€¢ 
        <strong>Reset:</strong> Every 5 hours & Weekly
    </div>

    <div class="dashboard-grid">
        <!-- 5-Hour Session Limit -->
        <div class="rate-limit-card">
            <div class="rate-limit-header">
                <div class="rate-limit-title">5-Hour Session Limit</div>
                <div class="rate-limit-status" id="fiveHourStatus">SAFE</div>
            </div>
            
            <div class="progress-container">
                <div class="progress-bar" id="fiveHourProgress">
                    <div class="progress-text" id="fiveHourText">0%</div>
                </div>
            </div>
            
            <div class="time-remaining">
                Next Reset: <span id="fiveHourReset">Loading...</span>
            </div>
            
            <div class="usage-stats">
                <div class="stat-item">
                    <div class="stat-value" id="fiveHourTokens">0</div>
                    <div class="stat-label">Tokens Used</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="fiveHourPrompts">0</div>
                    <div class="stat-label">Prompts</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="fiveHourRemaining">100%</div>
                    <div class="stat-label">Remaining</div>
                </div>
            </div>
        </div>

        <!-- Weekly Session Limit -->
        <div class="rate-limit-card">
            <div class="rate-limit-header">
                <div class="rate-limit-title">Weekly Limit</div>
                <div class="rate-limit-status" id="weeklyStatus">SAFE</div>
            </div>
            
            <div class="progress-container">
                <div class="progress-bar" id="weeklyProgress">
                    <div class="progress-text" id="weeklyText">0%</div>
                </div>
            </div>
            
            <div class="time-remaining">
                Week Ends: <span id="weeklyReset">Loading...</span>
            </div>
            
            <div class="usage-stats">
                <div class="stat-item">
                    <div class="stat-value" id="weeklyTokens">0</div>
                    <div class="stat-label">Total Tokens</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="weeklySessions">0</div>
                    <div class="stat-label">Sessions</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="weeklyRemaining">100%</div>
                    <div class="stat-label">Remaining</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Real Token Data Display -->
    <div class="real-data-card">
        <div class="token-display">
            <div class="stat-label">Latest Session Token Count</div>
            <div class="token-count" id="tokenCount">Loading...</div>
            <div class="stat-label">Session ID: <span id="sessionId">Loading...</span></div>
        </div>
        
        <button class="refresh-btn" onclick="loadRealRateLimitData()">ðŸ”„ Refresh Rate Limits</button>
        
        <div style="text-align: center; color: #64748b; margin-top: 15px;">
            Last updated: <span id="lastUpdate">Loading...</span>
        </div>
    </div>

    <script>
        // Rate limit calculations for Max 5x Pro plan ($100/month)
        const RATE_LIMITS = {
            fiveHour: {
                // Conservative estimate: ~150 prompts per 5 hours
                maxPrompts: 150,
                // Estimate ~2000 tokens per prompt (input + output)
                maxTokens: 300000,  // 150 prompts * 2000 tokens
            },
            weekly: {
                // Conservative estimate: ~1000 prompts per week  
                maxPrompts: 1000,
                // Weekly token estimate
                maxTokens: 2000000,  // 1000 prompts * 2000 tokens
            }
        };

        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }
        
        function getProgressColor(percentage) {
            if (percentage < 70) return 'safe';
            if (percentage < 90) return 'warning';
            return 'danger';
        }
        
        function getStatusText(percentage) {
            if (percentage < 70) return 'SAFE';
            if (percentage < 90) return 'WARNING';
            return 'DANGER';
        }
        
        function calculateTimeRemaining() {
            const now = new Date();
            
            // Calculate next 5-hour reset (assuming resets at 0, 5, 10, 15, 20 hours)
            const currentHour = now.getHours();
            const nextFiveHourReset = Math.ceil(currentHour / 5) * 5;
            const fiveHourReset = new Date(now);
            if (nextFiveHourReset >= 24) {
                fiveHourReset.setDate(fiveHourReset.getDate() + 1);
                fiveHourReset.setHours(0, 0, 0, 0);
            } else {
                fiveHourReset.setHours(nextFiveHourReset, 0, 0, 0);
            }
            
            // Calculate next Monday (weekly reset)
            const weeklyReset = new Date(now);
            const daysUntilMonday = (8 - now.getDay()) % 7 || 7;
            weeklyReset.setDate(weeklyReset.getDate() + daysUntilMonday);
            weeklyReset.setHours(0, 0, 0, 0);
            
            return {
                fiveHour: fiveHourReset,
                weekly: weeklyReset
            };
        }
        
        function formatTimeRemaining(date) {
            const now = new Date();
            const diff = date - now;
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            if (hours > 24) {
                const days = Math.floor(hours / 24);
                return `${days}d ${hours % 24}h`;
            }
            return `${hours}h ${minutes}m`;
        }
        
        function updateProgressBar(elementId, percentage, type) {
            const progressBar = document.getElementById(elementId);
            const progressText = document.getElementById(elementId.replace('Progress', 'Text'));
            const statusElement = document.getElementById(elementId.replace('Progress', 'Status'));
            
            const color = getProgressColor(percentage);
            const status = getStatusText(percentage);
            
            progressBar.className = `progress-bar progress-${color}`;
            progressBar.style.width = `${Math.min(percentage, 100)}%`;
            progressText.textContent = `${percentage.toFixed(1)}%`;
            
            statusElement.className = `rate-limit-status status-${color}`;
            statusElement.textContent = status;
        }
        
        async function loadRealRateLimitData() {
            try {
                // Get real session data
                const response = await fetch('./moonlock-dashboard/real-session-data.json');
                let realTokens = 0;
                let sessionId = 'N/A';
                
                if (response.ok) {
                    const data = await response.json();
                    realTokens = data.realTokens || 0;
                    sessionId = data.activeSessionId || 'N/A';
                }
                
                // Mock current session data (in production, this would come from database)
                const currentSessionTokens = realTokens;
                const currentSessionPrompts = Math.ceil(currentSessionTokens / 2000); // Estimate prompts
                
                // Mock weekly data (in production, this would aggregate all sessions this week)
                const weeklyTokens = currentSessionTokens;
                const weeklySessions = 1;
                
                // Calculate percentages
                const fiveHourTokenPercentage = (currentSessionTokens / RATE_LIMITS.fiveHour.maxTokens) * 100;
                const fiveHourPromptPercentage = (currentSessionPrompts / RATE_LIMITS.fiveHour.maxPrompts) * 100;
                const fiveHourPercentage = Math.max(fiveHourTokenPercentage, fiveHourPromptPercentage);
                
                const weeklyTokenPercentage = (weeklyTokens / RATE_LIMITS.weekly.maxTokens) * 100;
                const weeklyPromptPercentage = (weeklySessions / RATE_LIMITS.weekly.maxPrompts) * 100;
                const weeklyPercentage = Math.max(weeklyTokenPercentage, weeklyPromptPercentage);
                
                // Update 5-hour progress
                updateProgressBar('fiveHourProgress', fiveHourPercentage, 'fiveHour');
                
                // Update weekly progress
                updateProgressBar('weeklyProgress', weeklyPercentage, 'weekly');
                
                // Update stats
                document.getElementById('fiveHourTokens').textContent = formatNumber(currentSessionTokens);
                document.getElementById('fiveHourPrompts').textContent = currentSessionPrompts;
                document.getElementById('fiveHourRemaining').textContent = `${(100 - fiveHourPercentage).toFixed(1)}%`;
                
                document.getElementById('weeklyTokens').textContent = formatNumber(weeklyTokens);
                document.getElementById('weeklySessions').textContent = weeklySessions;
                document.getElementById('weeklyRemaining').textContent = `${(100 - weeklyPercentage).toFixed(1)}%`;
                
                // Update time remaining
                const timeRemaining = calculateTimeRemaining();
                document.getElementById('fiveHourReset').textContent = formatTimeRemaining(timeRemaining.fiveHour);
                document.getElementById('weeklyReset').textContent = formatTimeRemaining(timeRemaining.weekly);
                
                // Update main token display
                document.getElementById('tokenCount').textContent = formatNumber(realTokens);
                document.getElementById('sessionId').textContent = sessionId.length > 16 ? sessionId.substring(0, 16) + '...' : sessionId;
                document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
                
            } catch (error) {
                console.error('Error loading rate limit data:', error);
                // Show fallback data
                document.getElementById('tokenCount').textContent = formatNumber(1304152);
                document.getElementById('sessionId').textContent = 'bbd41f5f...';
                document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
            }
        }
        
        // Load data on page load
        loadRealRateLimitData();
        
        // Auto-refresh every 30 seconds
        setInterval(loadRateLimitData, 30000);
        
        // Update time remaining every minute
        setInterval(() => {
            const timeRemaining = calculateTimeRemaining();
            document.getElementById('fiveHourReset').textContent = formatTimeRemaining(timeRemaining.fiveHour);
            document.getElementById('weeklyReset').textContent = formatTimeRemaining(timeRemaining.weekly);
        }, 60000);
    </script>
</body>
</html>

    <script>
        // Override the loadRateLimitData function to use real calculated data
        async function loadRealRateLimitData() {
            try {
                // Load real rate limit calculations
                const rateLimitResponse = await fetch('./moonlock-dashboard/rate-limit-status.json');
                let rateLimitData = null;
                
                if (rateLimitResponse.ok) {
                    rateLimitData = await rateLimitResponse.json();
                }
                
                // Load session data
                const sessionResponse = await fetch('./moonlock-dashboard/real-session-data.json');
                let sessionData = null;
                
                if (sessionResponse.ok) {
                    sessionData = await sessionResponse.json();
                }
                
                if (rateLimitData) {
                    // Update 5-hour block progress
                    const fiveHour = rateLimitData.five_hour_block;
                    updateProgressBar('fiveHourProgress', fiveHour.usage_percentage, 'fiveHour');
                    
                    document.getElementById('fiveHourTokens').textContent = formatNumber(fiveHour.total_tokens);
                    document.getElementById('fiveHourPrompts').textContent = fiveHour.total_prompts;
                    document.getElementById('fiveHourRemaining').textContent = `${(100 - fiveHour.usage_percentage).toFixed(1)}%`;
                    
                    // Update weekly progress
                    const weekly = rateLimitData.weekly_limit;
                    updateProgressBar('weeklyProgress', weekly.usage_percentage, 'weekly');
                    
                    document.getElementById('weeklyTokens').textContent = formatNumber(weekly.total_tokens);
                    document.getElementById('weeklySessions').textContent = weekly.total_sessions;
                    document.getElementById('weeklyRemaining').textContent = `${(100 - weekly.usage_percentage).toFixed(1)}%`;
                    
                    // Update time remaining
                    const fiveHourMinutes = fiveHour.time_remaining_minutes;
                    const fiveHourHours = Math.floor(fiveHourMinutes / 60);
                    const fiveHourMins = fiveHourMinutes % 60;
                    document.getElementById('fiveHourReset').textContent = `${fiveHourHours}h ${fiveHourMins}m`;
                    
                    const weeklyDays = weekly.days_remaining;
                    document.getElementById('weeklyReset').textContent = `${weeklyDays} days`;
                    
                    console.log('âœ… Loaded real rate limit data:', rateLimitData);
                } else {
                    console.warn('âš ï¸ Could not load rate limit data, using fallback');
                    // Use fallback calculations if rate limit data not available
                    await loadRateLimitData();
                }
                
                // Update main token display
                if (sessionData) {
                    const realTokens = sessionData.realTokens || 0;
                    const sessionId = sessionData.activeSessionId || 'N/A';
                    
                    document.getElementById('tokenCount').textContent = formatNumber(realTokens);
                    document.getElementById('sessionId').textContent = sessionId.length > 16 ? sessionId.substring(0, 16) + '...' : sessionId;
                }
                
                document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
                
            } catch (error) {
                console.error('Error loading real rate limit data:', error);
                // Fallback to mock data
                await loadRateLimitData();
            }
        }
        
        // Replace the original function
        window.loadRateLimitData = loadRealRateLimitData;
    </script>
