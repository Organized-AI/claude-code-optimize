<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Code Rate Limit Tracker üî• LIVE</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
            min-height: 100vh;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        h1 {
            color: #60a5fa;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .live-indicator {
            background: linear-gradient(45deg, #10b981, #34d399);
            color: white;
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            display: inline-block;
            animation: pulse 2s infinite;
        }
        
        .connection-status {
            margin: 10px 0;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: bold;
        }
        
        .connection-status.connected {
            background: #065f46;
            color: #34d399;
        }
        
        .connection-status.connecting {
            background: #92400e;
            color: #fbbf24;
        }
        
        .connection-status.error {
            background: #7f1d1d;
            color: #fca5a5;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .progress-card {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid #475569;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        .progress-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        
        .progress-title {
            font-size: 1.25rem;
            font-weight: bold;
            color: #f1f5f9;
        }
        
        .progress-subtitle {
            font-size: 0.875rem;
            color: #94a3b8;
            margin-bottom: 12px;
        }
        
        .progress-bar-container {
            background: #0f172a;
            border-radius: 8px;
            height: 12px;
            margin-bottom: 16px;
            overflow: hidden;
            border: 1px solid #334155;
        }
        
        .progress-bar {
            height: 100%;
            border-radius: 6px;
            transition: width 0.5s ease-in-out;
            position: relative;
        }
        
        .progress-bar.safe {
            background: linear-gradient(90deg, #10b981, #34d399);
        }
        
        .progress-bar.warning {
            background: linear-gradient(90deg, #f59e0b, #fbbf24);
        }
        
        .progress-bar.danger {
            background: linear-gradient(90deg, #dc2626, #f87171);
        }
        
        .progress-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        .stat-item {
            text-align: center;
            padding: 12px;
            background: rgba(15, 23, 42, 0.5);
            border-radius: 8px;
            border: 1px solid #334155;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #60a5fa;
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: #94a3b8;
        }
        
        .main-display {
            text-align: center;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 24px;
            border: 1px solid #475569;
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.4);
        }
        
        .token-count {
            font-size: 3rem;
            font-weight: bold;
            color: #60a5fa;
            margin-bottom: 8px;
            font-family: 'SF Mono', 'Courier New', monospace;
        }
        
        .session-info {
            font-size: 1rem;
            color: #94a3b8;
            margin-bottom: 16px;
        }
        
        .status-indicators {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: bold;
        }
        
        .status-badge.safe {
            background: #065f46;
            color: #34d399;
        }
        
        .status-badge.warning {
            background: #92400e;
            color: #fbbf24;
        }
        
        .status-badge.danger {
            background: #7f1d1d;
            color: #fca5a5;
        }
        
        .last-update {
            font-size: 0.875rem;
            color: #64748b;
            margin-top: 16px;
        }
        
        .error-message {
            background: #7f1d1d;
            color: #fca5a5;
            padding: 16px;
            border-radius: 8px;
            margin: 16px 0;
            border: 1px solid #991b1b;
        }
        
        .debug-info {
            margin-top: 20px;
            padding: 16px;
            background: rgba(15, 23, 42, 0.8);
            border-radius: 8px;
            border: 1px solid #334155;
            font-family: 'SF Mono', 'Courier New', monospace;
            font-size: 0.75rem;
            color: #94a3b8;
        }
        
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .token-count {
                font-size: 2rem;
            }
            
            .progress-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöÄ Claude Code Rate Limit Tracker</h1>
        <div class="live-indicator" id="liveIndicator">üî¥ CONNECTING...</div>
        <div class="connection-status connecting" id="connectionStatus">
            Connecting to live data...
        </div>
    </div>

    <div class="main-display">
        <div class="token-count" id="tokenCount">Loading...</div>
        <div class="session-info">
            Session: <span id="sessionId">Loading...</span><br>
            Model: <span id="modelUsed">Loading...</span>
        </div>
        
        <div class="status-indicators">
            <div class="status-badge safe" id="statusBadge">SAFE</div>
        </div>
        
        <div class="last-update">
            Last Update: <span id="lastUpdate">Never</span>
        </div>
    </div>

    <div class="dashboard-grid">
        <div class="progress-card">
            <div class="progress-header">
                <span class="progress-title">‚è∞ 5-Hour Block Progress</span>
            </div>
            <div class="progress-subtitle">Current 5-hour session usage</div>
            
            <div class="progress-bar-container">
                <div class="progress-bar safe" id="fiveHourProgress" style="width: 0%"></div>
            </div>
            
            <div class="progress-stats">
                <div class="stat-item">
                    <div class="stat-value" id="fiveHourTokens">0</div>
                    <div class="stat-label">Tokens Used</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="fiveHourRemaining">5h 0m</div>
                    <div class="stat-label">Time Remaining</div>
                </div>
            </div>
        </div>

        <div class="progress-card">
            <div class="progress-header">
                <span class="progress-title">üìÖ Weekly Progress</span>
            </div>
            <div class="progress-subtitle">7-day rolling usage limit</div>
            
            <div class="progress-bar-container">
                <div class="progress-bar safe" id="weeklyProgress" style="width: 0%"></div>
            </div>
            
            <div class="progress-stats">
                <div class="stat-item">
                    <div class="stat-value" id="weeklyTokens">0</div>
                    <div class="stat-label">Tokens Used</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="weeklyRemaining">7 days</div>
                    <div class="stat-label">Days Remaining</div>
                </div>
            </div>
        </div>
    </div>

    <div class="debug-info" id="debugInfo">
        üîÑ Fetching live data...
    </div>

    <script>
        class LiveDashboard {
            constructor() {
                this.apiEndpoints = [
                    'http://localhost:3003',  // Local API bridge
                    // Add your cloud endpoint here when available
                ];
                this.currentEndpoint = 0;
                this.connectionStatus = 'connecting';
                this.retryCount = 0;
                this.maxRetries = 3;
                
                this.init();
            }
            
            init() {
                this.updateConnectionStatus('connecting', 'Connecting to live data...');
                this.loadLiveData();
                
                // Auto-refresh every 10 seconds
                setInterval(() => this.loadLiveData(), 10000);
            }
            
            async loadLiveData() {
                try {
                    const sessionData = await this.fetchData('/session-data');
                    const rateLimitData = await this.fetchData('/rate-limits');
                    
                    if (sessionData && rateLimitData) {
                        this.updateDashboard(sessionData, rateLimitData);
                        this.updateConnectionStatus('connected', 'üü¢ Live data connected');
                        this.retryCount = 0;
                    } else {
                        throw new Error('No data received');
                    }
                    
                } catch (error) {
                    console.error('Error loading live data:', error);
                    this.handleConnectionError(error);
                }
            }
            
            async fetchData(endpoint) {
                const baseUrl = this.apiEndpoints[this.currentEndpoint];
                
                try {
                    const response = await fetch(`${baseUrl}${endpoint}`, {
                        method: 'GET',
                        mode: 'cors',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    return await response.json();
                    
                } catch (error) {
                    // Try next endpoint if available
                    if (this.currentEndpoint < this.apiEndpoints.length - 1) {
                        this.currentEndpoint++;
                        return await this.fetchData(endpoint);
                    }
                    throw error;
                }
            }
            
            updateDashboard(sessionData, rateLimitData) {
                try {
                    // Update main display
                    const session = sessionData.sessionData;
                    const realTokens = session.realTokens || 0;
                    const sessionId = session.activeSessionId || 'No active session';
                    const modelUsed = session.modelUsed || 'Unknown';
                    
                    document.getElementById('tokenCount').textContent = this.formatNumber(realTokens);
                    document.getElementById('sessionId').textContent = 
                        sessionId.length > 20 ? sessionId.substring(0, 20) + '...' : sessionId;
                    document.getElementById('modelUsed').textContent = modelUsed;
                    
                    // Update progress bars
                    this.updateProgressBar('fiveHourProgress', rateLimitData.fiveHourLimit.usage_percentage);
                    this.updateProgressBar('weeklyProgress', rateLimitData.weeklyLimit.usage_percentage);
                    
                    // Update stats
                    document.getElementById('fiveHourTokens').textContent = 
                        this.formatNumber(rateLimitData.fiveHourLimit.total_tokens);
                    document.getElementById('weeklyTokens').textContent = 
                        this.formatNumber(rateLimitData.weeklyLimit.total_tokens);
                    
                    // Update time remaining
                    const fiveHourMinutes = rateLimitData.fiveHourLimit.time_remaining_minutes;
                    const hours = Math.floor(fiveHourMinutes / 60);
                    const minutes = fiveHourMinutes % 60;
                    document.getElementById('fiveHourRemaining').textContent = `${hours}h ${minutes}m`;
                    
                    const daysRemaining = rateLimitData.weeklyLimit.days_remaining;
                    document.getElementById('weeklyRemaining').textContent = `${daysRemaining} days`;
                    
                    // Update status badge
                    const maxUsage = Math.max(
                        rateLimitData.fiveHourLimit.usage_percentage,
                        rateLimitData.weeklyLimit.usage_percentage
                    );
                    
                    const statusBadge = document.getElementById('statusBadge');
                    if (maxUsage < 70) {
                        statusBadge.className = 'status-badge safe';
                        statusBadge.textContent = 'SAFE';
                    } else if (maxUsage < 90) {
                        statusBadge.className = 'status-badge warning';
                        statusBadge.textContent = 'WARNING';
                    } else {
                        statusBadge.className = 'status-badge danger';
                        statusBadge.textContent = 'DANGER';
                    }
                    
                    document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
                    
                    // Update debug info
                    document.getElementById('debugInfo').innerHTML = `
                        üìä Data Source: ${sessionData.dataSource || 'live_api'}<br>
                        üîó Endpoint: ${this.apiEndpoints[this.currentEndpoint]}<br>
                        üì° Last Fetch: ${new Date().toISOString()}<br>
                        üéØ Active: ${session.isActive ? 'Yes' : 'No'}<br>
                        üí∞ Session Cost: $${(session.costEstimate || 0).toFixed(4)}
                    `;
                    
                } catch (error) {
                    console.error('Error updating dashboard:', error);
                    this.showError('Error updating dashboard display');
                }
            }
            
            updateProgressBar(elementId, percentage) {
                const progressBar = document.getElementById(elementId);
                const safePercentage = Math.min(percentage, 100);
                
                progressBar.style.width = `${safePercentage}%`;
                
                // Update color based on usage
                if (safePercentage < 70) {
                    progressBar.className = 'progress-bar safe';
                } else if (safePercentage < 90) {
                    progressBar.className = 'progress-bar warning';
                } else {
                    progressBar.className = 'progress-bar danger';
                }
            }
            
            updateConnectionStatus(status, message) {
                this.connectionStatus = status;
                const statusElement = document.getElementById('connectionStatus');
                const liveIndicator = document.getElementById('liveIndicator');
                
                statusElement.className = `connection-status ${status}`;
                statusElement.textContent = message;
                
                if (status === 'connected') {
                    liveIndicator.textContent = 'üü¢ LIVE DATA';
                    liveIndicator.style.background = 'linear-gradient(45deg, #10b981, #34d399)';
                } else if (status === 'connecting') {
                    liveIndicator.textContent = 'üü° CONNECTING...';
                    liveIndicator.style.background = 'linear-gradient(45deg, #f59e0b, #fbbf24)';
                } else {
                    liveIndicator.textContent = 'üî¥ CONNECTION ERROR';
                    liveIndicator.style.background = 'linear-gradient(45deg, #dc2626, #f87171)';
                }
            }
            
            handleConnectionError(error) {
                this.retryCount++;
                
                if (this.retryCount < this.maxRetries) {
                    this.updateConnectionStatus('connecting', 
                        `Retrying connection... (${this.retryCount}/${this.maxRetries})`);
                    
                    setTimeout(() => this.loadLiveData(), 5000);
                } else {
                    this.updateConnectionStatus('error', 
                        `Connection failed: ${error.message}`);
                    this.showError(`Failed to connect to live data: ${error.message}`);
                }
            }
            
            showError(message) {
                const debugInfo = document.getElementById('debugInfo');
                debugInfo.innerHTML = `
                    <div class="error-message">
                        ‚ùå ${message}<br>
                        üîÑ Will retry in 10 seconds...<br>
                        üí° Make sure the Live Data API is running on localhost:3003
                    </div>
                `;
            }
            
            formatNumber(num) {
                if (num >= 1000000) {
                    return (num / 1000000).toFixed(1) + 'M';
                } else if (num >= 1000) {
                    return (num / 1000).toFixed(1) + 'K';
                }
                return num.toString();
            }
        }
        
        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new LiveDashboard();
        });
    </script>
</body>
</html>
