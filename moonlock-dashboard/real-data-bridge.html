<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Code Optimizer - REAL SESSION DATA</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #0f172a;
            color: #e2e8f0;
        }
        h1 {
            color: #60a5fa;
            text-align: center;
        }
        .real-indicator {
            background: #166534;
            color: #4ade80;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
            margin-left: 10px;
        }
        .session-card {
            background: #1e293b;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #334155;
        }
        .active-session {
            border-left: 4px solid #10b981;
        }
        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .session-id {
            font-family: 'Monaco', 'Courier New', monospace;
            background: #0f172a;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 14px;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .metric {
            background: #0f172a;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #60a5fa;
        }
        .metric-label {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 5px;
        }
        .progress-bar {
            background: #334155;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            background: linear-gradient(90deg, #10b981, #60a5fa);
            height: 100%;
            transition: width 0.3s ease;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-active { background: #10b981; animation: pulse 2s infinite; }
        .status-completed { background: #64748b; }
        .loading {
            text-align: center;
            color: #fbbf24;
            padding: 40px;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
        }
        .connected {
            background: #166534;
            color: #4ade80;
        }
        .disconnected {
            background: #7f1d1d;
            color: #f87171;
        }
    </style>
</head>
<body>
    <div id="connectionStatus" class="connection-status disconnected">
        Connecting to Real Session Tracker...
    </div>

    <h1>
        Claude Code Optimizer Dashboard
        <span class="real-indicator">REAL DATA</span>
    </h1>
    
    <div id="activeSessionsContainer">
        <div class="loading">Loading real Claude sessions...</div>
    </div>
    
    <div id="analyticsContainer"></div>
    
    <div id="fiveHourBlocksContainer"></div>

    <script>
        let ws = null;
        let isConnected = false;

        const REAL_SESSION_API = 'http://localhost:3001/api';
        const WS_URL = 'ws://localhost:3001/ws';

        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            isConnected = connected;
            
            if (connected) {
                statusEl.textContent = 'üü¢ Live Connection to Real Session Tracker';
                statusEl.className = 'connection-status connected';
            } else {
                statusEl.textContent = 'üî¥ Disconnected from Real Session Tracker';
                statusEl.className = 'connection-status disconnected';
            }
        }

        function connectWebSocket() {
            try {
                ws = new WebSocket(WS_URL);
                
                ws.onopen = function() {
                    console.log('Connected to real session tracker');
                    updateConnectionStatus(true);
                };
                
                ws.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    console.log('Real session update:', data);
                    
                    if (data.type === 'initial_data') {
                        displayRealSessions(data.active_sessions);
                        displayAnalytics(data.analytics);
                        displayFiveHourBlocks(data.five_hour_blocks);
                    } else if (data.type === 'session_update') {
                        loadAllData(); // Refresh all data on session changes
                    }
                };
                
                ws.onclose = function() {
                    console.log('Disconnected from real session tracker');
                    updateConnectionStatus(false);
                    setTimeout(connectWebSocket, 5000); // Retry connection
                };
                
                ws.onerror = function(error) {
                    console.error('WebSocket error:', error);
                    updateConnectionStatus(false);
                };
                
            } catch (error) {
                console.error('Failed to connect WebSocket:', error);
                updateConnectionStatus(false);
                setTimeout(connectWebSocket, 5000);
            }
        }

        async function loadAllData() {
            try {
                const [sessions, analytics, blocks] = await Promise.all([
                    fetch(`${REAL_SESSION_API}/sessions/active`).then(r => r.json()),
                    fetch(`${REAL_SESSION_API}/analytics/current`).then(r => r.json()),
                    fetch(`${REAL_SESSION_API}/five-hour-blocks`).then(r => r.json())
                ]);
                
                displayRealSessions(sessions);
                displayAnalytics(analytics);
                displayFiveHourBlocks(blocks);
                
            } catch (error) {
                console.error('Error loading real data:', error);
                document.getElementById('activeSessionsContainer').innerHTML = 
                    '<div class="session-card"><h3>‚ùå Cannot connect to real session tracker</h3><p>Make sure the session tracker is running on localhost:3001</p><p>Start it with: <code>./start.sh</code></p></div>';
            }
        }

        function displayRealSessions(sessions) {
            const container = document.getElementById('activeSessionsContainer');
            
            if (!sessions || sessions.length === 0) {
                container.innerHTML = `
                    <div class="session-card">
                        <h3>‚è∏Ô∏è No Active Claude Sessions</h3>
                        <p>Start Claude Desktop or run a Claude Code command to see real session tracking!</p>
                        <p>The tracker is monitoring for:</p>
                        <ul>
                            <li>Claude Desktop app launches</li>
                            <li><code>claude --dangerously-skip-permissions</code> commands</li>
                        </ul>
                    </div>
                `;
                return;
            }
            
            let html = '<h2>üéØ Active Real Sessions</h2>';
            
            sessions.forEach(session => {
                const duration = Math.round(session.duration_minutes || 0);
                const hours = Math.floor(duration / 60);
                const minutes = duration % 60;
                const durationStr = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
                
                html += `
                    <div class="session-card active-session">
                        <div class="session-header">
                            <h3>
                                <span class="status-indicator status-active"></span>
                                ${session.session_type.replace('_', ' ').toUpperCase()}
                            </h3>
                            <div class="session-id">ID: ${session.id.substring(0, 8)}</div>
                        </div>
                        
                        <div class="metrics-grid">
                            <div class="metric">
                                <div class="metric-value">${durationStr}</div>
                                <div class="metric-label">Duration</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value">${session.total_messages || 0}</div>
                                <div class="metric-label">Messages</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value">${(session.estimated_tokens || 0).toLocaleString()}</div>
                                <div class="metric-label">Tokens</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value">PID ${session.process_id}</div>
                                <div class="metric-label">Process ID</div>
                            </div>
                        </div>
                        
                        ${session.project_path ? `<p><strong>Project:</strong> ${session.project_path}</p>` : ''}
                        ${session.models_used && session.models_used.length > 0 ? 
                            `<p><strong>Models:</strong> ${session.models_used.join(', ')}</p>` : ''}
                        
                        <p><strong>Started:</strong> ${new Date(session.start_time).toLocaleString()}</p>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function displayAnalytics(analytics) {
            const container = document.getElementById('analyticsContainer');
            
            if (!analytics) return;
            
            let totalSessions = 0;
            let totalTokens = 0;
            
            if (analytics.today) {
                Object.values(analytics.today).forEach(stats => {
                    totalSessions += stats.sessions || 0;
                    totalTokens += stats.tokens || 0;
                });
            }
            
            let html = `
                <div class="session-card">
                    <h3>üìä Today's Real Usage Analytics</h3>
                    <div class="metrics-grid">
                        <div class="metric">
                            <div class="metric-value">${totalSessions}</div>
                            <div class="metric-label">Sessions Today</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">${(totalTokens / 1000).toFixed(1)}K</div>
                            <div class="metric-label">Tokens Used</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">${analytics.total_active_sessions || 0}</div>
                            <div class="metric-label">Active Now</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">${new Date(analytics.last_updated).toLocaleTimeString()}</div>
                            <div class="metric-label">Last Updated</div>
                        </div>
                    </div>
            `;
            
            // Current 5-hour block progress
            if (analytics.current_block) {
                const block = analytics.current_block;
                const progressPercent = block.progress_percent || 0;
                const remainingHours = Math.floor(block.remaining_minutes / 60);
                const remainingMins = Math.round(block.remaining_minutes % 60);
                
                html += `
                    <h4>üïê Current 5-Hour Block Progress</h4>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progressPercent}%"></div>
                    </div>
                    <p><strong>Progress:</strong> ${progressPercent.toFixed(1)}% ‚Ä¢ <strong>Remaining:</strong> ${remainingHours}h ${remainingMins}m</p>
                    <p><strong>Block Sessions:</strong> ${block.sessions} ‚Ä¢ <strong>Block Tokens:</strong> ${(block.tokens || 0).toLocaleString()}</p>
                `;
            } else {
                html += '<p>No active 5-hour block - will start automatically when Claude session begins</p>';
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        function displayFiveHourBlocks(blocks) {
            const container = document.getElementById('fiveHourBlocksContainer');
            
            if (!blocks || blocks.length === 0) return;
            
            let html = `
                <div class="session-card">
                    <h3>üìÖ Recent 5-Hour Session Blocks</h3>
            `;
            
            blocks.slice(0, 3).forEach(block => {
                const status = block.is_complete ? 'Completed' : 'Active';
                const statusClass = block.is_complete ? 'status-completed' : 'status-active';
                const duration = Math.round(block.duration_minutes || 0);
                const hours = Math.floor(duration / 60);
                const minutes = duration % 60;
                
                html += `
                    <div style="margin: 15px 0; padding: 15px; background: #0f172a; border-radius: 6px;">
                        <p>
                            <span class="status-indicator ${statusClass}"></span>
                            <strong>${status}</strong> ‚Ä¢ ${hours}h ${minutes}m
                        </p>
                        <p><strong>Sessions:</strong> ${block.total_sessions || 0} ‚Ä¢ <strong>Tokens:</strong> ${(block.total_tokens || 0).toLocaleString()}</p>
                        <p><strong>Started:</strong> ${new Date(block.start_time).toLocaleString()}</p>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Initialize connections
        connectWebSocket();
        loadAllData();
        
        // Auto-refresh every 30 seconds as fallback
        setInterval(loadAllData, 30000);
    </script>
</body>
</html>
