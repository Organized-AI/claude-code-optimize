<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Session Monitor</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0f1419; color: #c9d1d9; padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { color: #58a6ff; margin-bottom: 10px; }
        .status-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 20px; 
            margin-bottom: 30px;
        }
        .card { 
            background: #161b22; 
            border: 1px solid #30363d; 
            border-radius: 8px; 
            padding: 20px;
        }
        .card h3 { color: #58a6ff; margin-bottom: 15px; }
        .active-session { 
            background: #0d1117; 
            border: 1px solid #238636; 
            padding: 10px; 
            margin: 5px 0; 
            border-radius: 5px;
        }
        .session-type { color: #7c3aed; font-weight: bold; }
        .duration { color: #f85149; }
        .tokens { color: #a5f3fc; }
        .block-progress { 
            background: #21262d; 
            height: 20px; 
            border-radius: 10px; 
            overflow: hidden; 
            margin: 10px 0;
        }
        .progress-bar { 
            background: linear-gradient(90deg, #238636, #58a6ff); 
            height: 100%; 
            transition: width 0.3s ease;
        }
        .status { color: #238636; }
        .metrics { display: flex; justify-content: space-between; margin: 10px 0; }
        .metric { text-align: center; }
        .metric-value { font-size: 24px; font-weight: bold; color: #58a6ff; }
        .metric-label { font-size: 12px; color: #8b949e; }
        .footer { text-align: center; margin-top: 30px; color: #8b949e; }
        .refresh-btn { 
            background: #238636; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 10px;
        }
        .refresh-btn:hover { background: #2ea043; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Claude Session Monitor</h1>
            <p>Real-time tracking of Claude Desktop and Claude Code sessions</p>
            <button class="refresh-btn" onclick="loadData()">üîÑ Refresh</button>
            <span id="last-updated" class="status"></span>
        </div>

        <div class="status-grid">
            <div class="card">
                <h3>üìä Active Sessions</h3>
                <div id="active-sessions">
                    <p>Loading...</p>
                </div>
            </div>

            <div class="card">
                <h3>üïê Current 5-Hour Block</h3>
                <div id="current-block">
                    <p>Loading...</p>
                </div>
            </div>

            <div class="card">
                <h3>üìà Today's Analytics</h3>
                <div id="analytics">
                    <p>Loading...</p>
                </div>
            </div>

            <div class="card">
                <h3>üìÖ Recent 5-Hour Blocks</h3>
                <div id="recent-blocks">
                    <p>Loading...</p>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>Monitoring localhost:3001 ‚Ä¢ Dashboard syncs to Netlify every 30s</p>
        </div>
    </div>

    <script>
        let ws = null;
        
        function connectWebSocket() {
            try {
                ws = new WebSocket('ws://localhost:3001/ws');
                
                ws.onopen = function() {
                    console.log('WebSocket connected');
                    document.getElementById('last-updated').textContent = 'üü¢ Connected';
                };
                
                ws.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    updateDashboard(data);
                };
                
                ws.onclose = function() {
                    console.log('WebSocket disconnected');
                    document.getElementById('last-updated').textContent = 'üî¥ Disconnected';
                    setTimeout(connectWebSocket, 5000);
                };
                
                ws.onerror = function(error) {
                    console.error('WebSocket error:', error);
                    document.getElementById('last-updated').textContent = '‚ö†Ô∏è Error';
                };
            } catch (error) {
                console.error('Failed to connect WebSocket:', error);
                document.getElementById('last-updated').textContent = '‚ùå Failed to connect';
            }
        }
        
        function updateDashboard(data) {
            if (data.type === 'initial_data') {
                updateActiveSessions(data.active_sessions);
                updateAnalytics(data.analytics);
                updateFiveHourBlocks(data.five_hour_blocks);
            } else if (data.type === 'session_update') {
                loadData();
            }
            
            document.getElementById('last-updated').textContent = 
                `üü¢ Updated: ${new Date().toLocaleTimeString()}`;
        }
        
        function updateActiveSessions(sessions) {
            const container = document.getElementById('active-sessions');
            
            if (!sessions || sessions.length === 0) {
                container.innerHTML = '<p>No active sessions</p>';
                return;
            }
            
            let html = '';
            sessions.forEach(session => {
                const duration = Math.round(session.duration_minutes || 0);
                html += `
                    <div class="active-session">
                        <div><span class="session-type">${session.session_type}</span></div>
                        <div>Duration: <span class="duration">${duration}m</span></div>
                        <div>Messages: ${session.total_messages || 0}</div>
                        <div>Tokens: <span class="tokens">${(session.estimated_tokens || 0).toLocaleString()}</span></div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function updateAnalytics(analytics) {
            const container = document.getElementById('analytics');
            
            if (!analytics || !analytics.today) {
                container.innerHTML = '<p>No analytics data</p>';
                return;
            }
            
            let totalSessions = 0;
            let totalTokens = 0;
            
            Object.values(analytics.today).forEach(stats => {
                totalSessions += stats.sessions || 0;
                totalTokens += stats.tokens || 0;
            });
            
            const currentBlock = analytics.current_block;
            let blockHtml = '';
            if (currentBlock) {
                const progressPercent = currentBlock.progress_percent || 0;
                blockHtml = `
                    <div>
                        <p>Block Progress: ${progressPercent.toFixed(1)}%</p>
                        <div class="block-progress">
                            <div class="progress-bar" style="width: ${progressPercent}%"></div>
                        </div>
                        <p>Remaining: ${Math.round(currentBlock.remaining_minutes || 0)}m</p>
                    </div>
                `;
                
                document.getElementById('current-block').innerHTML = blockHtml;
            } else {
                document.getElementById('current-block').innerHTML = '<p>No active 5-hour block</p>';
            }
            
            container.innerHTML = `
                <div class="metrics">
                    <div class="metric">
                        <div class="metric-value">${totalSessions}</div>
                        <div class="metric-label">Sessions Today</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">${(totalTokens / 1000).toFixed(1)}K</div>
                        <div class="metric-label">Tokens Today</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">${analytics.total_active_sessions || 0}</div>
                        <div class="metric-label">Active Now</div>
                    </div>
                </div>
            `;
        }
        
        function updateFiveHourBlocks(blocks) {
            const container = document.getElementById('recent-blocks');
            
            if (!blocks || blocks.length === 0) {
                container.innerHTML = '<p>No recent blocks</p>';
                return;
            }
            
            let html = '';
            blocks.slice(0, 3).forEach(block => {
                const status = block.is_complete ? '‚úÖ Complete' : '‚è≥ Active';
                const duration = Math.round(block.duration_minutes || 0);
                html += `
                    <div style="margin: 10px 0; padding: 10px; background: #0d1117; border-radius: 5px;">
                        <div>${status} ‚Ä¢ ${duration}m</div>
                        <div>Sessions: ${block.total_sessions || 0} ‚Ä¢ Tokens: ${(block.total_tokens || 0).toLocaleString()}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        async function loadData() {
            try {
                const [sessions, analytics, blocks] = await Promise.all([
                    fetch('http://localhost:3001/api/sessions/active').then(r => r.json()),
                    fetch('http://localhost:3001/api/analytics/current').then(r => r.json()),
                    fetch('http://localhost:3001/api/five-hour-blocks').then(r => r.json())
                ]);
                
                updateActiveSessions(sessions);
                updateAnalytics(analytics);
                updateFiveHourBlocks(blocks);
                
                document.getElementById('last-updated').textContent = 
                    `üü¢ Updated: ${new Date().toLocaleTimeString()}`;
                    
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('last-updated').textContent = '‚ùå Error loading data';
            }
        }
        
        // Initialize
        connectWebSocket();
        loadData();
        
        // Auto-refresh every 30 seconds as fallback
        setInterval(loadData, 30000);
    </script>
</body>
</html>